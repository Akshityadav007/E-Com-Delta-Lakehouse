name: Deploy Databricks Workflows

on:
  push:
    branches:
      - feature/*
      - dev
      - uat
      - prod

  pull_request:
    types:
      - opened
      - reopened
    branches:
      - dev
      - uat
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Environment protection gates
    environment:
      name: ${{ github.ref_name }}   # dev / uat / prod
      url: https://example.com       # optional

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install databricks-cli requests

      - name: Select Environment
        id: envselect
        run: |
          echo "BRANCH=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Deploy to target workspace
        env:
          BRANCH: ${{ env.BRANCH }}
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Deploying to $BRANCH workspace..."
          python ci-cd/deploy.py "$DATABRICKS_HOST" "$DATABRICKS_TOKEN"
          echo "Deployment to $BRANCH workspace completed."